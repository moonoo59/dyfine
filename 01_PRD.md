# PRD — 가정용 자금 운영 서비스 (Phase1~Phase2) v1.1
작성일: 2026-02-25

> 목표: **“입력은 최소, 의사결정은 최대”**  
> 원칙: 생활비/용돈의 **세부 사용내역은 기록하지 않고**, 큰 틀(카테고리 L2) 중심으로 운영한다.

---

## 1) 배경과 문제 정의
### 1.1 현재 문제
- 계좌(급여/생활/고정지출/저축/비상금/투자)가 여러 개로 분산되어 **현금 흐름이 한눈에 안 보임**
- 자동이체를 “됐는지” 확인해야 하는데 **누락/지연**이 발생
- 생활비는 세부 내역을 남기기 싫지만, 최소한 **큰 틀에서 예산 vs 실적**은 보고 싶음
- 대출은 금리 변경/중도상환/납입일/일수 이자 등으로 **정확 계산과 이력 보존**이 필요
- 투자 역시 실시간 시세까지는 불필요하나, **평단 기반 대략적인 평가/배분/드리프트**는 보고 싶음

### 1.2 목표(Goals)
- 계좌 간 이동을 포함한 **월간 현금 흐름(Actual/Expected)** 시각화
- 자동이체를 **“예정 → 수동 확인 → 실적 반영”**으로 운영
- 예산(Plan) 대비 실적(Actual)을 **큰 카테고리(L2)** 수준으로 통제
- (Phase2) 대출: **금리 이력 + 월 전표(락) + 일수 기반 이자**로 정확 산출 및 불변성 확보
- (Phase2) 투자: 평단/수량 기반으로 **자산 배분/손익/드리프트**를 시각화

### 1.3 비목표(Non-goals)
- 오픈뱅킹/카드사 API 자동 연동(유료/보안/운영 복잡도 증가)
- 실시간 시세 자동 갱신(외부 API 의존, 무료 목표 위배)
- 생활비/용돈의 세부 지출 자동 수집(요구사항과 충돌)

---

## 2) 사용자/권한/인증
### 2.1 사용자 모델
- 가구(=Household) 단위로 운영
- 구성원은 1명(공용 계정) 또는 2명(개별 계정) 모두 지원

### 2.2 로그인(필수)
- Supabase Auth(email/password) 사용
- **공용 계정(가구 공유 1계정) 허용**: 부부가 같은 계정으로 사용 가능
- 권장 운영(보안 관점): 계정은 분리하되 Household 공유(추후 확장)

### 2.3 권한(Role)
- **Owner**: 설정/마감/락/대출 생성/금리 변경/중도상환 이벤트, 데이터 관리
- **Member**: 거래 입력/확인/조회

---

## 3) 운영 원칙(핵심 정책)
1. 생활비는 세부 미기록, **월 1회 합산 입력**을 기본 제공
2. 개인 용돈은 **지급액만 기록**, 사용내역 미기록
3. 세부 구분이 필요하면 **태그**로만 보조
4. 시각화/집계의 기준은 **Actual(확정 전표)**  
   - Expected(예정 자동이체/예정 납입)은 **오버레이**로만 표시
5. 월 마감 시 해당 월 전표는 **락(수정 불가)**  
   - 변경 필요 시 **조정 전표**로만 반영(감사성 유지)
6. 대출 금리 변경 시 **과거 이자 전표는 건드리지 않고**, 적용일 이후부터 반영

---

## 4) 기능 범위와 단계(Phase)
### Phase 1 (MVP)
- Auth/Household/Member/RLS
- 계좌/계좌그룹/카테고리/태그(사용자 정의)
- 거래 입력(수입/지출/이체) + 즐겨찾기 + 최근 복제 + 인박스
- 자동이체(규칙/인스턴스/수동확인/미확인 알림)
- 예산(템플릿/월 override) + Plan vs Actual
- 대시보드 시각화: Sankey / Balance(Actual·Projected) / Waterfall
- CSV Import(클라이언트 파싱) + 룰 기반 분류(패턴→카테고리/태그)
- 월 마감(Closing) + 락 + 조정 전표

### Phase 2 (대출/투자)
- 대출: 상환방식별 스케줄/일수 이자/금리 이력/중도상환 이벤트/전표 락/현금흐름 자동 반영
- 투자: 종목/보유/평단/가격(수동/CSV)/평가/배분/드리프트/월 스냅샷
- “남는 돈 배분” 시뮬레이터(클라이언트 계산) + 계획 저장(선택)

---

## 5) 데이터 분류 체계
### 5.1 카테고리(L1/L2, 사용자 정의 가능)
기본 제공(초기 세트):
- 대출: 신용대출이자, 원리금상환
- 주거비: 주택자금대출 원리금, 전세자금대출이자(과거)
- 생활비: 여선 용돈, 덕원 용돈, 고정지출, 카드할부금
- 차량유지비: 차량유지비, 차량구매할부
- 저축 및 투자: 저축, 투자, 비상금
- 오구 관련: 오구 생활비, 오구 보험료
- 무누 관련: 무누 생활비, 무누 적금

### 5.2 태그(선택)
초기 제공 예시:
- #고정비 #구독 #공과금 #통신 #보험 #카드할부
- #대출 #이자 #원금
- #오구 #무누 #차량
- #저축 #투자 #비상금

---

## 6) 핵심 사용자 스토리(User Stories)
### Phase 1
- U1: 계좌를 등록하고 이번 달 Actual 잔액과 흐름을 한 화면에서 본다.
- U2: 자동이체를 체크리스트로 확인하고, 확인 시 실적에 반영한다.
- U3: 생활비는 월 합산만 기록하고 예산 초과 여부만 확인한다.
- U4: 즐겨찾기/복제로 10초 안에 거래 입력을 끝낸다.
- U5: CSV를 올리면 중복 없이 들어오고 룰로 자동 분류된다.
- U6: 월 마감 후 과거가 바뀌지 않는다(조정 전표만 허용).

### Phase 2
- U7: 금리 변경이 있어도 과거 이자는 보존되고 이후부터 새 금리로 계산된다.
- U8: 납입일/일수 기준으로 이자·원금·수수료가 정확히 계산된다.
- U9: 중도상환 입력 시 수수료 포함 반영되고 이후 스케줄이 재산정된다.
- U10: 평단/수량 기반으로 투자 평가/배분/드리프트를 본다.

---

## 7) 기능 요구사항(Functional Requirements)

### F1. 계좌(Account) / 그룹
- 계좌: name, group, type(bank/brokerage/virtual/external), currency, opening_balance, is_active
- 계좌그룹: 사용자 정의(이름 변경 가능)
- External(외부) 계정은 시스템이 내부적으로 사용할 수 있음(수입/지출 대응)

**AC(수용 기준)**
- 계좌/그룹명 변경 시 과거 데이터/집계가 깨지지 않는다.
- 비활성 계좌는 기본 화면에서 숨김 처리 가능.

---

### F2. 거래(Transaction) — 복식부기 전표
- 전표(Entry) + 라인(Lines) 구조(라인 합계=0)
- 타입: income / expense / transfer / adjustment
- 필수: occurred_at, amount, from/to(account), category(L2), (optional) tags, memo
- 편의: 즐겨찾기 템플릿, 최근 복제, 인박스(미분류)

**AC**
- 즐겨찾기 기반 입력은 10초 내 가능.
- 전표 라인 합이 0이 아니면 저장 불가.

---

### F3. 자동이체(Auto Transfer) — 예정/확인/실적
- 규칙(Rule): from/to, 예상금액, 주기(매월 n일), 허용오차(±일/금액), 카테고리, 태그, start/end, 활성
- 인스턴스(Instance): 월초 생성, 상태 pending/confirmed/missed
- 확인(Confirm): 클릭 시 전표 자동 생성(source=auto_transfer) + 링크
- 알림: 미확인/미실행만(앱 내 + Web Push)

**AC**
- “확인” 클릭 시 즉시 Actual 집계에 반영.
- 기한 경과 시 missed 표시 및 알림 생성.

---

### F4. 예산(Budget) — Plan vs Actual
- 템플릿(기본 세트) + 월별 override
- 표: 예산/실적/차이/진행률 (+옵션: 예정 포함)

**AC**
- 카테고리(L2) 기준으로 초과/잔여를 즉시 확인 가능.

---

### F5. 월 마감(Closing) & 락
- 마감 실행 시:
  - 월 요약 스냅샷 저장
  - 미확인 자동이체 경고
  - 해당 월 전표 is_locked=true
- 수정 필요 시:
  - 기존 전표 수정 금지, adjustment 전표로만 반영

**AC**
- 마감된 월은 UPDATE/DELETE 불가(정책 레벨에서 차단).
- 조정 전표는 원본과 연결(선택)되어 추적 가능.

---

### F6. Import(CSV) & 룰 엔진
- Import: 브라우저에서 파싱 → API로 업로드(서버 비용 최소화)
- 중복 탐지: 날짜+금액+메모 해시(또는 원장키)로 중복 방지
- 룰 엔진: 패턴→카테고리/태그 자동 부착(입력/Import 시점에만)

**AC**
- 동일 CSV를 2번 업로드해도 중복 생성되지 않는다.
- 룰 우선순위에 따라 분류 결과가 결정된다.

---

### F7. 대시보드/리포트(시각화)
- Sankey: Actual(실선) + Expected(점선 토글)
- Balance: Actual/Projected 탭
- Waterfall: 월 수입→카테고리 지출→순증감
- Reports: 카테고리/태그 Top, 검색/필터, (옵션) CSV Export

**AC**
- 클릭/드릴다운으로 거래 리스트 필터가 연결된다.

---

## 8) Phase2 상세 요구사항

### P2-L1. 대출(Loan)
#### 입력(대출 생성)
- name, principal_original, start_date, maturity_date/term_months
- repayment_type: interest_only / annuity / equal_principal / custom_schedule
- interest_pay_day(매월 n일), day_count_convention(ACT/365 기본), rounding_rule
- linked_payment_account_id
- rate_history: effective_date별 annual_rate
- 중도상환 수수료: 기본 수동 입력(정확성 우선)

#### 산출
- loan_ledger_entries(월 전표, locked=true): period, posting_date, interest/principal/fee, balance_after
- 금리 변경: 과거 전표 불변, 적용일 이후부터 반영
- 현금흐름 반영: 납입일에 출금계좌→External 전표 자동 생성(이자/원금/수수료 분리 가능)

**AC**
- 금리 이력 변경 시 과거 월 이자액은 변하지 않는다.
- 납입 전표와 현금흐름 전표가 연결되어 추적 가능하다.

---

### P2-I1. 투자(Invest)
#### 입력
- security(ticker/name/currency)
- holdings: account_id, qty, avg_price
- last_price: 수동 또는 CSV 업데이트
- (선택) 월 스냅샷 저장

#### 산출
- 평가금액/손익/배분(계좌/종목)
- 드리프트(목표 비중 vs 현재 비중)
- 리밸런싱 제안(권고 수준, 저장만)

**AC**
- 가격 업데이트 시 평가/배분/드리프트가 즉시 갱신된다.

---

## 9) 비기능 요구사항(NFR) & 보안
### 9.1 보안(필수)
- Supabase RLS로 household_id 단위 데이터 격리
- Worker service key는 Cloudflare secret에만 저장(클라이언트 노출 금지)
- 마감된 월 is_locked는 DB 정책으로 UPDATE/DELETE 차단
- 중요한 이벤트는 audit_logs 기록

### 9.2 프론트 보안
- CSP 적용, XSS 방지(출력 인코딩/입력 sanitize)
- 로그인/민감 액션 rate limit (Cloudflare 레이어)
- (선택) Cloudflare Turnstile로 로그인 폼 보호

### 9.3 성능/비용(무료 플랜)
- 무거운 계산(대출 시뮬/리밸런싱)은 클라이언트에서 수행
- 서버 배치(자동이체 인스턴스 생성/알림)는 Cron 중심

---

## 10) 성공 지표(내부 KPI)
- 자동이체 미확인 건수(0 목표)
- 월 마감 실행률
- 월 입력 건수(생활비는 월 1회 합산으로 최소화)
- 예산 초과 카테고리 수 감소

supabase db password ghddbswo0512